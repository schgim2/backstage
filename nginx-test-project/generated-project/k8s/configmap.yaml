apiVersion: v1
kind: ConfigMap
metadata:
  name: ${{ values.name }}-config
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: nginx-web-service
    app.kubernetes.io/instance: ${{ values.name }}
data:
  nginx.conf: |
    # NGINX Main Configuration
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log notice;
    pid /var/run/nginx.pid;
    
    events {
        worker_connections 1024;
        use epoll;
        multi_accept on;
    }
    
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        server_tokens off;
        
        {% if values.enableCaching %}
        proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:${{ values.cacheSize }} max_size=${{ values.cacheSize }} inactive=60m use_temp_path=off;
        {% endif %}
        
        {% if values.enableRateLimit %}
        limit_req_zone $binary_remote_addr zone=api:10m rate=${{ values.rateLimitRpm }}r/m;
        limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
        {% endif %}
        
        {% if values.enableGzip %}
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;
        {% endif %}
        
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        {% if values.enableSSL %}
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        {% endif %}
        
        {% if values.enableAccessLogs %}
        {% if values.logFormat == "json" %}
        log_format json_combined escape=json '{"time_local":"$time_local","remote_addr":"$remote_addr","remote_user":"$remote_user","request":"$request","status": "$status","body_bytes_sent":"$body_bytes_sent","request_time":"$request_time","http_referrer":"$http_referer","http_user_agent":"$http_user_agent","http_x_forwarded_for":"$http_x_forwarded_for"}';
        access_log /var/log/nginx/access.log json_combined;
        {% else %}
        access_log /var/log/nginx/access.log combined;
        {% endif %}
        {% else %}
        access_log off;
        {% endif %}
        
        include /etc/nginx/conf.d/*.conf;
    }
  
  default.conf: |
    server {
        listen 80;
        {% if values.domain %}
        server_name ${{ values.domain }}{% if values.additionalDomains %} {{ values.additionalDomains | join(" ") }}{% endif %};
        {% else %}
        server_name _;
        {% endif %}
        
        {% if values.serviceType == "static-site" or values.serviceType == "spa-application" %}
        root /usr/share/nginx/html;
        index index.html index.htm;
        {% endif %}
        
        {% if values.allowedIPs %}
        {% for ip in values.allowedIPs %}
        allow {{ ip }};
        {% endfor %}
        deny all;
        {% endif %}
        
        {% if values.enableBasicAuth %}
        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
        {% endif %}
        
        {% if values.enableRateLimit %}
        limit_req zone=api burst={{ values.rateLimitRpm // 4 }} nodelay;
        limit_conn conn_limit_per_ip 10;
        {% endif %}
        
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        location /ready {
            access_log off;
            return 200 "ready\n";
            add_header Content-Type text/plain;
        }
        
        {% if values.enableMonitoring %}
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 127.0.0.1;
            allow 10.0.0.0/8;
            deny all;
        }
        {% endif %}
        
        {% if values.serviceType == "static-site" %}
        location / {
            try_files $uri $uri/ =404;
            
            location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
            
            location ~* \.(html|htm)$ {
                expires 1h;
                add_header Cache-Control "public";
            }
        }
        {% elif values.serviceType == "spa-application" %}
        location / {
            try_files $uri $uri/ /index.html;
            
            location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
            
            location = /index.html {
                expires -1;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
            }
        }
        {% endif %}
        
        {% if values.enableErrorPages %}
        error_page 404 /errors/404.html;
        error_page 500 502 503 504 /errors/50x.html;
        
        location ^~ /errors/ {
            internal;
            root /usr/share/nginx/html;
        }
        {% endif %}
        
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }

---
{% if values.enableBasicAuth %}
apiVersion: v1
kind: Secret
metadata:
  name: ${{ values.name }}-auth
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: nginx-web-service
    app.kubernetes.io/instance: ${{ values.name }}
type: Opaque
data:
  # Default: admin:admin (change after deployment)
  .htpasswd: YWRtaW46JGFwcjEkSDY1dnVhNzAkLnRiVUNvbVlsUzFmUXlGdGpIcC4w
{% endif %}