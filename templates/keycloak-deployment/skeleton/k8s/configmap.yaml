apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-config
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: ${{ values.name }}
data:
  keycloak.conf: |
    # Database Configuration
    db=${{ values.databaseType }}
    {% if values.databaseMode == "managed" %}
    db-url-host=postgresql
    db-url-database=keycloak
    db-url-port=5432
    {% endif %}
    db-username=keycloak
    db-password=${KC_DB_PASSWORD}
    
    # Hostname Configuration
    {% if values.domain %}
    hostname={{ values.domain }}
    {% endif %}
    {% if values.enableSSL %}
    hostname-strict-https=true
    {% else %}
    hostname-strict-https=false
    {% endif %}
    
    # Proxy Configuration
    proxy=edge
    
    # HTTP Configuration
    http-enabled=true
    http-port=8080
    {% if values.enableSSL %}
    https-port=8443
    {% endif %}
    
    # Logging Configuration
    log-level={{ values.logLevel }}
    {% if values.enableAuditLogs %}
    log-console-output=json
    {% endif %}
    
    # Metrics Configuration
    {% if values.enableMetrics %}
    metrics-enabled=true
    {% endif %}
    
    # Health Configuration
    health-enabled=true
    
    # Cache Configuration
    {% if values.replicas > 1 %}
    cache=ispn
    cache-stack=kubernetes
    {% endif %}
    
    # Features Configuration
    {% if values.enableAdminAPI %}
    features=admin-api,admin2
    {% endif %}
    
    # Transaction Configuration
    transaction-xa-enabled=false

  {% if values.enableEventListeners %}
  event-listeners.json: |
    {
      "eventListeners": [
        {
          "name": "jboss-logging",
          "enabled": true
        },
        {
          "name": "email",
          "enabled": true
        }
      ],
      "adminEventsEnabled": true,
      "adminEventsDetailsEnabled": true,
      "eventsEnabled": true,
      "eventsExpiration": 86400,
      "enabledEventTypes": [
        "LOGIN",
        "LOGIN_ERROR",
        "LOGOUT",
        "REGISTER",
        "UPDATE_PROFILE",
        "UPDATE_PASSWORD"
      ]
    }
  {% endif %}

  {% if values.enableThemes %}
  theme-config.json: |
    {
      "themes": {
        "login": "custom",
        "account": "custom",
        "admin": "custom",
        "email": "custom"
      },
      "internationalizationEnabled": true,
      "supportedLocales": ["en", "de", "fr", "es", "ja", "ko", "zh-CN"]
    }
  {% endif %}

---
{% if values.databaseMode == "managed" and values.databaseType == "postgresql" %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-config
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/instance: ${{ values.name }}
data:
  postgresql.conf: |
    # Connection Settings
    listen_addresses = '*'
    port = 5432
    max_connections = 200
    
    # Memory Settings
    shared_buffers = 256MB
    effective_cache_size = 1GB
    work_mem = 4MB
    maintenance_work_mem = 64MB
    
    # WAL Settings
    wal_level = replica
    max_wal_senders = 3
    max_replication_slots = 3
    
    # Logging Settings
    log_destination = 'stderr'
    logging_collector = on
    log_directory = 'log'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_statement = 'all'
    log_min_duration_statement = 1000
    
    # Performance Settings
    checkpoint_completion_target = 0.9
    random_page_cost = 1.1
    effective_io_concurrency = 200
    
    # Security Settings
    ssl = on
    ssl_cert_file = 'server.crt'
    ssl_key_file = 'server.key'
    
  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            md5
    host    all             all             ::1/128                 md5
    host    all             all             0.0.0.0/0               md5
    host    replication     all             0.0.0.0/0               md5
{% endif %}