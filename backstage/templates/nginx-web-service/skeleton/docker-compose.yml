version: '3.8'

services:
  # NGINX Web Service
  {{ values.name }}:
    image: nginx:${{ values.nginxVersion }}
    container_name: {{ values.name }}
    ports:
      - "${{ values.port }}:80"
      {% if values.enableSSL %}
      - "443:443"
      {% endif %}
      {% if values.enableMonitoring %}
      - "9113:9113"
      {% endif %}
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/default.conf:/etc/nginx/conf.d/default.conf:ro
      {% if values.enableErrorPages %}
      - ./html/errors:/usr/share/nginx/html/errors:ro
      {% endif %}
      {% if values.contentSource == "git" or values.contentSource == "empty" %}
      - ./html:/usr/share/nginx/html:ro
      {% endif %}
      {% if values.enableSSL %}
      - ./certs:/etc/nginx/certs:ro
      {% endif %}
      {% if values.enableCaching %}
      - nginx-cache:/var/cache/nginx
      {% endif %}
      - nginx-logs:/var/log/nginx
    environment:
      - NGINX_PORT=${{ values.port }}
      - NGINX_WORKER_PROCESSES=auto
      - NGINX_WORKER_CONNECTIONS=1024
      {% if values.enableBasicAuth %}
      - BASIC_AUTH_USER=${BASIC_AUTH_USER:-admin}
      - BASIC_AUTH_PASSWORD=${BASIC_AUTH_PASSWORD}
      {% endif %}
      {% if values.enableRateLimit %}
      - RATE_LIMIT_RPM=${{ values.rateLimitRpm }}
      {% endif %}
      {% if values.domain %}
      - SERVER_NAME=${{ values.domain }}
      {% endif %}
    networks:
      - web-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      {% if values.domain %}
      - "traefik.http.routers.{{ values.name }}.rule=Host(`{{ values.domain }}`)"
      {% if values.additionalDomains %}
      {% for domain in values.additionalDomains %}
      - "traefik.http.routers.{{ values.name }}.rule=Host(`{{ values.domain }}`) || Host(`{{ domain }}`)"
      {% endfor %}
      {% endif %}
      {% endif %}
      {% if values.enableSSL %}
      - "traefik.http.routers.{{ values.name }}.tls=true"
      - "traefik.http.routers.{{ values.name }}.tls.certresolver=letsencrypt"
      {% endif %}
      - "traefik.http.services.{{ values.name }}.loadbalancer.server.port=80"

  {% if values.enableMonitoring %}
  # NGINX Prometheus Exporter
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: {{ values.name }}-exporter
    ports:
      - "9113:9113"
    command:
      - -nginx.scrape-uri=http://{{ values.name }}/nginx_status
    networks:
      - web-network
    restart: unless-stopped
    depends_on:
      - {{ values.name }}
  {% endif %}

  {% if values.contentSource == "git" %}
  # Git Content Sync
  git-sync:
    image: k8s.gcr.io/git-sync/git-sync:v3.6.3
    container_name: {{ values.name }}-git-sync
    volumes:
      - ./html:/tmp/git:rw
    environment:
      - GIT_SYNC_REPO=${{ values.gitRepo }}
      - GIT_SYNC_BRANCH=main
      - GIT_SYNC_ROOT=/tmp/git
      - GIT_SYNC_DEST=content
      - GIT_SYNC_PERIOD=60s
      - GIT_SYNC_ONE_TIME=false
    networks:
      - web-network
    restart: unless-stopped
  {% endif %}

  # Reverse Proxy (Traefik)
  traefik:
    image: traefik:v3.0
    container_name: traefik
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik.yml:/etc/traefik/traefik.yml:ro
      {% if values.enableSSL %}
      - ./certs:/certs:rw
      {% endif %}
    networks:
      - web-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik.service=api@internal"

volumes:
  {% if values.enableCaching %}
  nginx-cache:
    driver: local
  {% endif %}
  nginx-logs:
    driver: local

networks:
  web-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16