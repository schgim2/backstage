apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: ${{ values.name }}
    app.kubernetes.io/version: "${{ values.keycloakVersion }}"
    app.kubernetes.io/component: identity-provider
spec:
  replicas: ${{ values.replicas }}
  selector:
    matchLabels:
      app.kubernetes.io/name: keycloak
      app.kubernetes.io/instance: ${{ values.name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: keycloak
        app.kubernetes.io/instance: ${{ values.name }}
        app.kubernetes.io/version: "${{ values.keycloakVersion }}"
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum }}
    spec:
      serviceAccountName: keycloak
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: keycloak
        image: quay.io/keycloak/keycloak:${{ values.keycloakVersion }}
        imagePullPolicy: IfNotPresent
        command:
          - /opt/keycloak/bin/kc.sh
        args:
          - start
          {% if values.deploymentMode == "development" %}
          - --dev
          {% endif %}
          - --config-file=/opt/keycloak/conf/keycloak.conf
        env:
        # Admin Configuration
        - name: KEYCLOAK_ADMIN
          valueFrom:
            secretKeyRef:
              name: keycloak-admin-creds
              key: username
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-admin-creds
              key: password
        
        # Database Configuration
        - name: KC_DB_USERNAME
          valueFrom:
            secretKeyRef:
              name: keycloak-db-creds
              key: username
        - name: KC_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: keycloak-db-creds
              key: password
        
        # JVM Configuration
        - name: JAVA_OPTS_APPEND
          value: >-
            -Djgroups.dns.query=keycloak-headless.${{ values.namespace }}.svc.cluster.local
            -Xms512m -Xmx2048m
            -XX:MetaspaceSize=96M -XX:MaxMetaspaceSize=256m
            -Djava.net.preferIPv4Stack=true
            -Djboss.modules.system.pkgs=org.jboss.byteman
            -Djava.awt.headless=true
        
        {% if values.enableVault %}
        # Vault Configuration
        - name: VAULT_TOKEN
          valueFrom:
            secretKeyRef:
              name: vault-auth
              key: vault-token
        - name: VAULT_URL
          valueFrom:
            secretKeyRef:
              name: vault-auth
              key: vault-url
        {% endif %}
        
        ports:
        - name: http
          containerPort: 8080
          protocol: TCP
        - name: https
          containerPort: 8443
          protocol: TCP
        {% if values.enableMetrics %}
        - name: metrics
          containerPort: 9990
          protocol: TCP
        {% endif %}
        
        livenessProbe:
          httpGet:
            path: /health/live
            port: http
          initialDelaySeconds: 120
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health/ready
            port: http
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        startupProbe:
          httpGet:
            path: /health/ready
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 30
        
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        
        volumeMounts:
        - name: keycloak-config
          mountPath: /opt/keycloak/conf/keycloak.conf
          subPath: keycloak.conf
          readOnly: true
        {% if values.enableEventListeners %}
        - name: keycloak-config
          mountPath: /opt/keycloak/conf/event-listeners.json
          subPath: event-listeners.json
          readOnly: true
        {% endif %}
        {% if values.enableThemes %}
        - name: keycloak-config
          mountPath: /opt/keycloak/conf/theme-config.json
          subPath: theme-config.json
          readOnly: true
        - name: custom-themes
          mountPath: /opt/keycloak/themes/custom
          readOnly: true
        {% endif %}
        {% if values.enableSSL and values.sslProvider == "manual" %}
        - name: ssl-certs
          mountPath: /opt/keycloak/conf/certs
          readOnly: true
        {% endif %}
        - name: keycloak-data
          mountPath: /opt/keycloak/data
      
      volumes:
      - name: keycloak-config
        configMap:
          name: keycloak-config
      {% if values.enableThemes %}
      - name: custom-themes
        configMap:
          name: keycloak-themes
          optional: true
      {% endif %}
      {% if values.enableSSL and values.sslProvider == "manual" %}
      - name: ssl-certs
        secret:
          secretName: keycloak-tls
      {% endif %}
      - name: keycloak-data
        {% if values.deploymentMode == "production" %}
        persistentVolumeClaim:
          claimName: keycloak-data
        {% else %}
        emptyDir: {}
        {% endif %}
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                  - keycloak
              topologyKey: kubernetes.io/hostname

---
{% if values.deploymentMode == "production" %}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: keycloak-data
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: ${{ values.name }}
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: ${{ values.storageClass }}
  resources:
    requests:
      storage: 10Gi
{% endif %}

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keycloak
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: ${{ values.name }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keycloak
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: ${{ values.name }}
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["endpoints"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keycloak
  namespace: ${{ values.namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/instance: ${{ values.name }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: keycloak
subjects:
- kind: ServiceAccount
  name: keycloak
  namespace: ${{ values.namespace }}